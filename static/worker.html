<!DOCTYPE html>
<html>

<head></head>

<body>
  <p id="p1">hello, world.</p>
  <button id="closeButton" onclick="closeMe()">Close</button>
  <script>
    const electron = require('electron')
    const ipcRenderer = electron.ipcRenderer
    const remote = electron.remote
    const http = require('http')
    const cheerio = require('cheerio')
    let spider

    function setSpider(arg) {
      this.spider = arg
    }
    ipcRenderer.on('setSpider', (event, args) => {
      setSpider(args)
      document.getElementById("p1").innerHTML = this.spider.name


      function working(spider) {
        let domain = this.spider.domain
        let url = this.spider.url
        let div
        for (let param of this.spider.params) {
          
        }
      }

      function readDaLianHaiYangJu() {
        let domainName = 'http://www.hyyyyj.dl.gov.cn'
        let url = 'http://www.hyyyyj.dl.gov.cn/hyhjyzhybjc/hyzhyb/'

        http.get(url, (res) => {
          let html = ''
          res.on('data', (data) => {
            html += data
          })
          res.on('end', () => {
            readDataUrl(domainName + getLinks(html))
          })
        })
      }

      function readDataUrl(url) {
        http.get(url, (res) => {
          let html = ''
          res.on('data', (data) => {
            html += data
          })
          res.on('end', () => {
            let htmldata = getDataFromHtml(html)
          })
        }).on('error', () => {
          console.log('获取数据出错!')
        })
      }

      function getLinks(html) {
        if (html) {
          let result = []
          let $ = cheerio.load(html)
          let linkDiv = $('#zty_yc_list')
          let linkList = linkDiv.find('ul')
          let listItems = linkList.find('li')
          listItems.each(function (i, elem) {
            let date = $(this).find('a').find('font').text()
            let link = $(this).find('a').attr('href')
            result.push({ date: date, link: link })
          })
          function SortByDate(x, y) {
            return ((x.date === y.date) ? 0 : ((x.date > y.date) ? 1 : -1))
          }
          result.sort(SortByDate)
          //console.log(result)
          return result[result.length - 1].link
        } else {
          console.log('无数据传入')
        }
      }

      function getDataFromHtml(html) {
        if (html) {
          let result = []
          let $ = cheerio.load(html)
          let innerhtml = $('body').find('p')
          innerhtml.each(function (i, elem) {
            let text = $(this).text()
            text = text.trim()
            if (text !== '') {
              result.push(text)
            }
          })
          console.log(result)
          return result
        } else {
          console.log('无数据传入！')
        }
      }

      function filterSlideList(html) {
        if (html) {
          var $ = cheerio.load(html)
          // 根据id获取轮播图列表信息
          var slideList = $('#foucsSlideList');
          // 轮播图数据
          var slideListData = [];

          /* 轮播图列表信息遍历 */
          slideList.find('li').each(function (item) {

            var pic = $(this);
            // 找到a标签并获取href属性
            var pic_href = pic.find('a').attr('href');
            // 找到a标签的子标签img并获取_src
            var pic_src = pic.find('a').children('img').attr('_src');
            // 找到a标签的子标签img并获取alt
            var pic_message = pic.find('a').children('img').attr('alt');
            // 向数组插入数据
            slideListData.push({
              pic_href: pic_href,
              pic_message: pic_message,
              pic_src: pic_src
            });
          });
          // 返回轮播图列表信息
          return slideListData;
        } else {
          console.log('无数据传入！')
        }
      }

      function printInfo(slideListData) {
        // 计数
        var count = 0;
        // 遍历信息列表
        slideListData.forEach(function (item) {
          // 获取图片
          var pic_src = item.pic_src;
          // 获取图片对应的链接地址
          var pic_href = item.pic_href;
          // 获取图片信息
          var pic_message = item.pic_message;
          // 打印信息
          console.log('第' + (++count) + '个轮播图');
          console.log(pic_message);
          console.log(pic_href);
          console.log(pic_src);
          console.log('\n');
        });
      }
    })

    function closeMe() {
      document.getElementById("p1").innerHTML = 'close me.'
      let window = remote.getCurrentWindow()
      window.close()
    }
  </script>
</body>

</html>